name: tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always
  LIB_NAME: darkbio_crypto_ffi

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Flutter with FVM
        uses: kuhnroyal/flutter-fvm-config-action/setup@v3
        with:
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze Dart code
        run: flutter analyze

  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Setup Flutter with FVM
        uses: kuhnroyal/flutter-fvm-config-action/setup@v3
        with:
          cache: true

      - name: Install flutter_rust_bridge_codegen
        run: cargo install flutter_rust_bridge_codegen

      - name: Install dependencies
        run: flutter pub get

      - name: Regenerate bridge
        run: flutter_rust_bridge_codegen generate

      - name: Patch FRB symbols for prefixing
        run: dart run scripts/prefix_frb_symbols.dart

      - name: Format Dart code
        run: dart format . --language-version=3.9

      - name: Format Rust code
        run: cargo fmt --all
        working-directory: rust

      - name: Check for changes
        run: git diff --exit-code

  clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Run Clippy
        run: cargo clippy --all-features -- -D warnings
        working-directory: rust

  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Build Rust docs
        run: cargo doc --all-features --no-deps
        working-directory: rust

  package:
    uses: ./.github/workflows/package.yml
